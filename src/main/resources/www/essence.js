/* essence javascripts. Includes a modified http://www.ivan.fomichev.name/2008/04/javascript-creole-10-wiki-markup-parser.html wiki parser. */ 
if(!Parse)var Parse={};if(!Parse.Simple)Parse.Simple={};Parse.Simple.Base=function(b,a){if(arguments.length)this.grammar=b,this.grammar.root=new this.ruleConstructor(this.grammar.root),this.options=a};
Parse.Simple.Base.prototype={ruleConstructor:null,grammar:null,options:null,parse:function(b,a,c){if(c)for(i in this.options)typeof c[i]=="undefined"&&(c[i]=this.options[i]);else c=this.options;a=a.replace(/\r\n?/g,"\n");this.grammar.root.apply(b,a,c);if(c&&c.forIE)b.innerHTML=b.innerHTML.replace(/\r?\n/g,"\r\n")}};Parse.Simple.Base.prototype.constructor=Parse.Simple.Base;Parse.Simple.Base.Rule=function(b){if(arguments.length){for(var a in b)this[a]=b[a];if(!this.children)this.children=[]}};
Parse.Simple.Base.prototype.ruleConstructor=Parse.Simple.Base.Rule;
Parse.Simple.Base.Rule.prototype={regex:null,capture:null,replaceRegex:null,replaceString:null,tag:null,attrs:null,children:null,match:function(b){return b.match(this.regex)},build:function(b,a,c){var f;this.capture!==null&&(f=a[this.capture]);this.tag?(a=document.createElement(this.tag),b.appendChild(a)):a=b;f&&(this.replaceRegex&&(f=f.replace(this.replaceRegex,this.replaceString)),this.apply(a,f,c));if(this.attrs)for(var e in this.attrs)if(a.setAttribute(e,this.attrs[e]),c&&c.forIE&&e=="class")a.className=
this.attrs[e];return this},apply:function(b,a,c){a=""+a;var f=[];if(!this.fallback.apply)this.fallback=new this.constructor(this.fallback);for(;;){for(var e=!1,g=!1,d=0;d<this.children.length;d++)if(typeof f[d]=="undefined"&&(this.children[d].match||(this.children[d]=new this.constructor(this.children[d])),f[d]=this.children[d].match(a,c)),f[d]&&(!e||e.index>f[d].index))if(e=f[d],g=this.children[d],e.index==0)break;d=e?e.index:a.length;d>0&&this.fallback.apply(b,a.substring(0,d),c);if(!e)break;g.build||
(g=new this.constructor(g));g.build(b,e,c);e=e.index+e[0].length;a=a.substring(e);for(d=0;d<this.children.length;d++)f[d]&&(f[d].index>=e?f[d].index-=e:f[d]=void 0)}return this},fallback:{apply:function(b,a,c){c&&c.forIE&&(a=a.replace(/\n/g," \r"));b.appendChild(document.createTextNode(a))}}};Parse.Simple.Base.Rule.prototype.constructor=Parse.Simple.Base.Rule;
Parse.Simple.Confluence=function(b){for(var a={singleLine:{regex:/.+/,capture:0},escape:{regex:/\\(.)/,capture:1},preBlock:{tag:"pre",capture:2,regex:/([^\\]\{code[^\}]*\}\n?)((.*?\n)*?.*?)(\{code\})/},noformat:{tag:"pre",capture:2,regex:/(\{noformat\})((.*?\n)*?.*?)(\{noformat\})/},macro:{build:function(){},regex:/(\{[^\}]*\})/},paragraph:{tag:"p",capture:0,regex:/(^|\n)([ \t]*\S.*(\n|$))+/},text:{capture:0,regex:/(^|\n)([ \t]*[^\s].*(\n|$))+/},strong:{tag:"strong",capture:1,regex:/\*([^*]*)\*/},
em:{tag:"em",capture:1,regex:/_([^*]*)_/},tt:{tag:"tt",regex:/\{\{(.*?)\}\}/,capture:1,replaceRegex:/\}\}\}$/,replaceString:""},hr:{tag:"hr",regex:/(^|\n)\s*----\s*(\n|$)/},ulist:{tag:"ul",capture:0,regex:/(^|\n)([ \t]*\*[^*#].*(\n|$)([ \t]*[^\s*#].*(\n|$))*([ \t]*[*#]{2}.*(\n|$))*)+/},olist:{tag:"ol",capture:0,regex:/(^|\n)([ \t]*#[^*#].*(\n|$)([ \t]*[^\s*#].*(\n|$))*([ \t]*[*#]{2}.*(\n|$))*)+/},li:{tag:"li",capture:0,regex:/[ \t]*([*#]).+(\n[ \t]*[^*#\s].*)*(\n[ \t]*\1[*#].+)*/,replaceRegex:/(^|\n)[ \t]*[*#]/g,
replaceString:"$1"},table:{tag:"table",capture:0,regex:/(^|\n)(\|.*?[ \t]*(\n|$))+/},tr:{tag:"tr",capture:2,regex:/(^|\n)(\|.*?)\|?[ \t]*(\n|$)/},th:{tag:"th",regex:/\|+\|([^|]*)/,capture:1},td:{tag:"td",regex:/\|+([^|]+)/,capture:1},br:{tag:"br",regex:/\\\\/}},c=1;c<=6;c++)a["h"+c]={tag:"h"+c,capture:3,regex:"(^|\\n)[ \\t]*(h"+c+".)[ \\t](.*)"};a.ulist.children=a.olist.children=[a.li];a.li.children=[a.ulist,a.olist];a.li.fallback=a.text;a.table.children=[a.tr];a.tr.children=[a.th,a.td];a.td.children=
[a.singleLine];a.th.children=[a.singleLine];a.h1.children=a.h2.children=a.h3.children=a.h4.children=a.h5.children=a.h6.children=a.singleLine.children=a.paragraph.children=a.text.children=a.strong.children=a.em.children=[a.strong,a.em,a.br,a.tt,a.macro,a.escape];a.root={children:[a.h1,a.h2,a.h3,a.h4,a.h5,a.h6,a.hr,a.ulist,a.olist,a.preBlock,a.noformat,a.table],fallback:{children:[a.paragraph]}};Parse.Simple.Base.call(this,a,b)};Parse.Simple.Confluence.prototype=new Parse.Simple.Base;
Parse.Simple.Confluence.prototype.constructor=Parse.Simple.Confluence;if(!navigator.userAgent.match(/WebKit\/([\d.]+)/))document.getElementById("message").innerHTML="Unsupported browser. Please try a webkit browser like Safari, Chrome or your mobile.";
$(function(){window.Document=Backbone.Model.extend({url:function(){return"data/document/"+this.id},fetchNstore:function(b){b||(b={});if(!b.quick||!localStorage.getItem(this.id))this.set(JSON.parse(localStorage.getItem(this.id))),this.fetch({success:function(a){localStorage.setItem(a.id,JSON.stringify(a.toJSON()))},error:function(a){a.set(JSON.parse(localStorage.getItem(a.id)))},silent:b.silent||b.quick})}});window.Favourite=Backbone.Model.extend({isCached:function(){return localStorage.getItem(this.id)!=
null}});window.Folder=Backbone.Collection.extend({model:Favourite,url:"data/favourites",parse:function(b){return b}});window.folder=new Folder;window.doco=new Document;window.DocumentView=Backbone.View.extend({el:$("#document"),template:_.template($("#document-template").html()),loading:_.template($("#loading-template").html()),initialize:function(){_.bindAll(this,"render");this.model=doco;this.model.bind("change",this.render)},render:function(){this.model.toJSON().title?(this.el.html(this.template(this.model.toJSON())),
(new Parse.Simple.Confluence({})).parse(document.getElementById("wiki"),this.model.get("content"))):this.el.html(this.loading(this.model.toJSON()));return this}});window.FavouriteView=Backbone.View.extend({tagName:"li",template:_.template($("#favourite-item-template").html()),events:{},initialize:function(){_.bindAll(this,"render")},render:function(){var b=this.model.toJSON();b.isCached=this.model.isCached();$(this.el).html(this.template(b));return this}});window.FolderView=Backbone.View.extend({el:$("#folder"),
initialize:function(){_.bindAll(this,"add","refresh");folder.bind("refresh",this.refresh);folder.fetch()},add:function(b){(new Document({id:b.id})).fetchNstore({quick:!0});b=new FavouriteView({model:b});this.$("#favourite-list").append(b.render().el)},refresh:function(b){this.$(".loading").show().siblings().remove();b.each(this.add);this.$(".loading").hide()}});window.Essence=Backbone.Controller.extend({routes:{refresh:"refresh",favourite:"favourite","":"index","document/:id":"document"},initialize:function(){this.f=
new FolderView;this.d=new DocumentView},refresh:function(){confirm("Are you sure to delete all offline content ("+localStorage.length+")?")&&(window.applicationCache&&window.applicationCache.status==window.applicationCache.UPDATEREADY&&window.applicationCache.swapCache(),localStorage.clear(),folder.fetch());location.hash="#favourite"},index:function(){$("section").hide();$("#index").show()},favourite:function(){$("section").hide();$("#folder").show()},document:function(b){doco.clear();doco.id=b;doco.fetchNstore();
$("section").hide();$("#document").show()}});essence=new Essence;Backbone.history.start()});
